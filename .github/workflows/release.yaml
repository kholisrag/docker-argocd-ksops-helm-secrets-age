name: "Github Release"

# This workflow creates GitHub releases with comprehensive release notes
# Features:
# - Generates changelog from conventional commits
# - Creates release notes with tool versions and pull commands
# - Publishes changelog to repository
# - Creates GitHub release with artifacts
# - Marks pre-releases automatically (tags with -rc, -alpha, -beta)
#
# Triggers:
# - Push tags v* for versioned releases
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: read

jobs:
  create-release:
    runs-on: ubuntu-24.04
    steps:
      - name: "Create GitHub App Token"
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.COMMITER_AND_TAGGER_APP_ID }}
          private-key: ${{ secrets.COMMITER_AND_TAGGER_APP_PRIVATE_KEY }}

      - name: "Checkout Repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for changelog generation
          token: ${{ steps.app-token.outputs.token }}

      - name: "Get GitHub App User ID"
        id: get-user-id
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: "Extract Tool Versions"
        id: versions
        uses: ./.github/actions/extract-versions

      - name: "Get Previous Tag"
        id: previous-tag
        run: |
          # Get the second most recent tag by commit date for comparison
          PREVIOUS_TAG=$(git tag --sort=-committerdate | sed -n '2p')
          echo "tag=$PREVIOUS_TAG" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREVIOUS_TAG"

      - name: "Generate Changelog"
        uses: requarks/changelog-action@v1
        id: changelog
        with:
          token: ${{ github.token }}
          fromTag: ${{ github.ref_name }}
          toTag: ${{ steps.previous-tag.outputs.tag }}
          writeToFile: true
          changelogFilePath: CHANGELOG.md
          includeInvalidCommits: false
          excludeTypes: "build,docs,other,style"

      - name: "Generate Release Notes"
        id: release_notes
        run: |
          # Create comprehensive release notes
          cat > release-notes.md << 'EOF'
          ## ðŸš€ Release ${{ github.ref_name }}

          ### ðŸ“¦ Container Images

          Pull this release using any of the following registries:

          ```bash
          # Docker Hub
          docker pull docker.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}

          # GitHub Container Registry
          docker pull ghcr.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}

          # Quay.io
          docker pull quay.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}
          ```

          ### ðŸ”§ Tool Versions

          This release includes the following tool versions:

          | Tool | Version |
          |------|---------|
          | **ArgoCD** | `${{ steps.versions.outputs.argocd_version }}` |
          | **ksops** | `${{ steps.versions.outputs.ksops_version }}` |
          | **age** | `${{ steps.versions.outputs.age_version }}` |
          | **helm-secrets** | `${{ steps.versions.outputs.helm_secrets_version }}` |
          | **sops** | `${{ steps.versions.outputs.sops_version }}` |
          | **kubectl** | `${{ steps.versions.outputs.kubectl_version }}` |
          | **vals** | `${{ steps.versions.outputs.vals_version }}` |
          | **static-curl** | `${{ steps.versions.outputs.static_curl_version }}` |

          ### ðŸ”’ Security & Supply Chain

          - âœ… **Trivy Scanned**: No HIGH or CRITICAL vulnerabilities
          - âœ… **SBOM Included**: Software Bill of Materials attached as attestation
          - âœ… **Provenance**: Build provenance with `mode=max`
          - âœ… **Multi-arch**: Supports `linux/amd64` and `linux/arm64`

          ### ðŸ“ Changelog

          EOF

          # Append the generated changelog
          cat CHANGELOG.md >> release-notes.md

          # Output for GitHub release
          echo "notes_file=release-notes.md" >> $GITHUB_OUTPUT

      - name: "Commit and Push Changelog"
        uses: stefanzweifel/git-auto-commit-action@v5
        id: auto-commit
        with:
          commit_message: "docs: update CHANGELOG.md for ${{ github.ref_name }} [skip ci]"
          commit_user_name: "${{ steps.app-token.outputs.app-slug }}[bot]"
          commit_user_email: "${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"
          commit_author: "${{ steps.app-token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com>"
          file_pattern: "CHANGELOG.md"
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
          disable_globbing: false
          create_branch: false
          branch: main

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
          generate_release_notes: false
          make_latest: "true"

      - name: "Generate Release Summary"
        run: |
          echo "## ðŸŽ‰ Release ${{ github.ref_name }} Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Image Locations" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Hub: \`docker.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- GHCR: \`ghcr.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Quay.io: \`quay.io/kholisrag/argocd-ksops-helm-secrets:${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Tool Versions" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD: ${{ steps.versions.outputs.argocd_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
