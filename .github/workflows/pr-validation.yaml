name: "PR Validation and Build"

# This workflow validates pull requests and builds release candidate images
# Features:
# - Validates PR title follows Conventional Commits format
# - Builds RC (Release Candidate) images only if PR title is valid
# - Pushes RC images only to GitHub Container Registry (GHCR)
# - Comments on PR with image details and tool versions
# - Calculates semantic version bump based on commit type
#
# Required PR title format: type(scope?): description
# Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
# Example: feat(api): add new authentication endpoint

# Only run on pull requests to validate conventional commits and optionally build RC images
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  # Validate that PR title follows conventional commit format
  validate-conventional-commit:
    runs-on: ubuntu-24.04
    outputs:
      semver_type: ${{ steps.semver.outputs.semver_type }}
    steps:
      - name: "Validate PR Title"
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Conventional commit types
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require scope to be present (optional)
          requireScope: false
          # Subject may not be empty
          subjectPattern: ^.+$
          # Subject must not end with a period
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            doesn't match the configured pattern. Please ensure that the subject
            doesn't end with a period and is not empty.
          # Disable body validation since we only check PR title
          validateSingleCommit: false
          # Add comment on failure
          ignoreLabels: |
            ignore-semantic-pull-request

      - name: "Determine Semver Type"
        id: semver
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Determine semver bump type from validated PR title
            let semverType = 'patch';
            if (title.includes('!') || title.match(/^(feat|fix)(\(.+\))?!/)) {
              semverType = 'major';
            } else if (title.startsWith('feat')) {
              semverType = 'minor';
            }

            core.setOutput('semver_type', semverType);
            core.notice(`Semver bump type: ${semverType}`);

  # Build RC (release candidate) image only if PR title is valid
  # Push only to GHCR, not to Docker Hub or Quay.io
  build-rc-image:
    runs-on: ubuntu-24.04
    needs: validate-conventional-commit
    outputs:
      rc_version: ${{ steps.rc_tag.outputs.rc_version }}
      image_tag: ${{ steps.get_tag.outputs.primary_tag }}
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Extract Tool Versions"
        id: versions
        uses: ./.github/actions/extract-versions

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: benjlevesque/short-sha@v3.0
        id: short-sha
        with:
          length: 7

      - name: "Generate RC Version Tag"
        id: rc_tag
        run: |
          # Get PR number
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Use ArgoCD version as base
          ARGOCD_VERSION="${{ steps.versions.outputs.argocd_version }}"

          # Count existing RC tags for this PR to determine the next RC number
          # List all tags matching pattern v{argocd_version}-rc{number}-*
          EXISTING_TAGS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/packages/container/$(echo ${{ github.repository }} | cut -d'/' -f2)/versions" \
            --jq ".[] | select(.metadata.container.tags[] | select(test(\"^v${ARGOCD_VERSION}-rc[0-9]+-\"))) | .metadata.container.tags[]" 2>/dev/null || echo "")

          # Extract RC numbers and find the highest
          if [ -z "$EXISTING_TAGS" ]; then
            RC_NUMBER=1
          else
            # Extract rc numbers (e.g., v3.2.1-rc2-abc1234 -> 2)
            HIGHEST_RC=$(echo "$EXISTING_TAGS" | grep -oP "v${ARGOCD_VERSION}-rc\K[0-9]+" | sort -n | tail -1)
            RC_NUMBER=$((HIGHEST_RC + 1))
          fi

          # Generate RC version: v{argocd_version}-rc{number}
          RC_VERSION="v${ARGOCD_VERSION}-rc${RC_NUMBER}"

          echo "rc_number=${RC_NUMBER}" >> $GITHUB_OUTPUT
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "::notice::RC Version: ${RC_VERSION} (RC build #${RC_NUMBER} for PR #${PR_NUMBER})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Docker Metadata for RC"
        id: meta
        uses: docker/metadata-action@v5
        env:
          DOCKER_METADATA_SHORT_SHA_LENGTH: 7
        with:
          images: |
            ghcr.io/kholisrag/argocd-ksops-helm-secrets
          flavor: |
            latest=false
            prefix=
          tags: |
            # RC version with SHA only: v{argocd_version}-rc{number}-{sha_short}
            type=raw,enable=true,priority=900,value=${{ steps.rc_tag.outputs.rc_version }}-${{ steps.short-sha.outputs.sha }}
          labels: |
            org.opencontainers.image.title=ArgoCD with ksops, helm-secrets, and age (RC)
            org.opencontainers.image.description=Release Candidate build from PR #${{ github.event.pull_request.number }}
            org.opencontainers.image.version=${{ steps.rc_tag.outputs.rc_version }}
            org.opencontainers.image.vendor=kholisrag
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/blob/main/README.md
            io.artifacthub.package.readme-url=https://raw.githubusercontent.com/${{ github.repository }}/main/README.md
            # Tool versions as labels
            tools.argocd.version=${{ steps.versions.outputs.argocd_version }}
            tools.ksops.version=${{ steps.versions.outputs.ksops_version }}
            tools.age.version=${{ steps.versions.outputs.age_version }}
            tools.helm-secrets.version=${{ steps.versions.outputs.helm_secrets_version }}
            tools.sops.version=${{ steps.versions.outputs.sops_version }}
            tools.kubectl.version=${{ steps.versions.outputs.kubectl_version }}
            tools.vals.version=${{ steps.versions.outputs.vals_version }}
            tools.static-curl.version=${{ steps.versions.outputs.static_curl_version }}
            build.revision=${{ steps.versions.outputs.build_revision }}

      - name: "Build and Push RC Image"
        uses: docker/build-push-action@v6
        id: build
        with:
          platforms: linux/amd64,linux/arm64
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          # Add SBOM and provenance attestations
          sbom: true
          provenance: mode=max
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_REVISION=${{ steps.versions.outputs.build_revision }}
            ARGOCD_VERSION=v${{ steps.versions.outputs.argocd_version }}
            KSOPS_VERSION=v${{ steps.versions.outputs.ksops_version }}
            SOPS_VERSION=${{ steps.versions.outputs.sops_version }}
            KUBECTL_VERSION=${{ steps.versions.outputs.kubectl_version }}
            VALS_VERSION=${{ steps.versions.outputs.vals_version }}
            AGE_VERSION=${{ steps.versions.outputs.age_version }}
            HELM_SECRETS_VERSION=${{ steps.versions.outputs.helm_secrets_version }}
            STATIC_CURL_VERSION=${{ steps.versions.outputs.static_curl_version }}

      - name: "Extract Primary Image Tag"
        id: get_tag
        run: |
          # Use RC version with SHA for E2E testing (the only tag we build)
          PRIMARY_TAG="${{ steps.rc_tag.outputs.rc_version }}-${{ steps.short-sha.outputs.sha }}"
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "::notice::Primary image tag for E2E: ${PRIMARY_TAG}"

      - name: "Comment on PR"
        uses: actions/github-script@v8
        with:
          script: |
            const rcVersion = '${{ steps.rc_tag.outputs.rc_version }}';
            const shortSha = '${{ steps.short-sha.outputs.sha }}';
            const imageName = 'ghcr.io/${{ github.repository }}';

            const rcNumber = '${{ steps.rc_tag.outputs.rc_number }}';
            const prNumber = '${{ github.event.pull_request.number }}';

            const comment = `## üöÄ Release Candidate Image Built

            **Version:** \`${rcVersion}-${shortSha}\`
            **RC Build:** #${rcNumber} for PR #${prNumber}

            ### üì¶ Pull Command
            \`\`\`bash
            docker pull ${imageName}:${rcVersion}-${shortSha}
            \`\`\`

            ### üîß Tool Versions
            - ArgoCD: \`${{ steps.versions.outputs.argocd_version }}\`
            - ksops: \`${{ steps.versions.outputs.ksops_version }}\`
            - age: \`${{ steps.versions.outputs.age_version }}\`
            - helm-secrets: \`${{ steps.versions.outputs.helm_secrets_version }}\`
            - sops: \`${{ steps.versions.outputs.sops_version }}\`
            - kubectl: \`${{ steps.versions.outputs.kubectl_version }}\`
            - vals: \`${{ steps.versions.outputs.vals_version }}\`
            - static-curl: \`${{ steps.versions.outputs.static_curl_version }}\`

            > ‚ö†Ô∏è This is a **Release Candidate** image for testing purposes only. It will not be promoted to production registries.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Run E2E tests on the RC image
  e2e-tests-rc:
    needs: build-rc-image
    uses: ./.github/workflows/e2e-tests.yaml
    with:
      image_tag: ${{ needs.build-rc-image.outputs.image_tag }}
    secrets:
      ARGOCD_AGE_PRIVATE_KEY_CONTENT: ${{ secrets.ARGOCD_AGE_PRIVATE_KEY_CONTENT }}
      ARGOCD_GITHUB_TOKEN: ${{ secrets.ARGOCD_GITHUB_TOKEN }}

  # Report E2E test results back to PR
  report-e2e-results:
    needs:
      - build-rc-image
      - e2e-tests-rc
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: "Comment E2E Results on PR"
        uses: actions/github-script@v8
        with:
          script: |
            const rcVersion = '${{ needs.build-rc-image.outputs.rc_version }}';
            const e2eStatus = '${{ needs.e2e-tests-rc.outputs.e2e_tests_status }}';
            const imageName = 'ghcr.io/${{ github.repository }}';

            let statusEmoji = '‚ùå';
            let statusText = 'Failed';
            let statusColor = 'üî¥';

            if (e2eStatus === 'passed') {
              statusEmoji = '‚úÖ';
              statusText = 'Passed';
              statusColor = 'üü¢';
            }

            const comment = `## ${statusEmoji} E2E Test Results

            **RC Version:** \`${rcVersion}\`
            **Status:** ${statusColor} **${statusText}**

            ### Test Details
            - Image tested: \`${imageName}:${rcVersion}\`
            - Workflow run: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ${e2eStatus === 'passed' ? '### ‚ú® All Tests Passed\nThe RC image has successfully passed all E2E tests and is ready for review.' : '### ‚ö†Ô∏è Tests Failed\nThe RC image failed E2E tests. Please review the logs and fix any issues before merging.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
